# Dockerfile — это файл с инструкциями для создания образа.
# Пишим Dockerfile для образа для backend
# Создать образ на основе базового слоя,
# который содержит файлы ОС и интерпретатор Python 3.9.
# Версию лучше указывать явсно (во избежании конфликтов)
# slim — в образ включены только самые необходимые пакеты
# Полный образ Python — это самая тяжёлая версия. 
FROM python:3.9-slim

# WORKDIR - это аналог команды cd в терминале.
# Переходим в образе в директорию /app: в ней будем хранить код проекта.
# Если директории с указанным именем нет, она будет создана. 
# Название директории может быть любым.
# В инструкции WORKDIR лучше указывать абсолютный путь до директории
# Абсолютный путь начинается со слеша (отсчитывается от корневой директории)
WORKDIR /app
# Дальнейшие инструкции будут выполняться в директории /app

# Скопировать с локального компьютера файл зависимостей
# в текущую директорию (текущая директория — это /app).
# Путь на локальном компьютере отсчитывается от директории,
# где хранится докерфайл.
COPY requirements.txt .
# Точка вместо пути внутри контейнера означает саму рабочую директорию.

# Выполнить в текущей директории команду терминала
# для установки зависимостей.
RUN pip install -r requirements.txt --no-cache-dir
# Утилита pip уже есть в образе — она включена в базовый слой.
# Нельзя запустить утилиту, которая не установлена.
# Пример команда - установить утилиту zip:
# RUN apt -y install zip

# Скопировать всё необходимое содержимое 
# той директории локального компьютера, где сохранён Dockerfile,
# в текущую рабочую директорию образа — /app.
COPY . .
# Точка в обоих случаях обозначает текущую директорию:
# первая на хосте, вторая — внутри образа

# При старте контейнера запустить сервер разработки.
# Указать номер порта и приложение, которое должен обслуживать gunicorn
CMD ["gunicorn", "--bind", "0.0.0.0:8000", "foodgram.wsgi"]
# Ключ --bind 0.0.0.0:8000 привяжет приложение foodgram к внешнему порту 8000
# Стандартная привязка к 127.0.0.1:8000 не сработает,
# так как обращение к контейнеру с хоста не считается локальным.

# Позже, когда из образа будет запущен контейнер,
# все пакеты в контейнере будут установлены из образа,
# скачивать их из репозиториев не потребуется.
